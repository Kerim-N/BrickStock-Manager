<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Brick Manager — Offline Single‑File App</title>
  <style>
    :root{
      --bg:#0f1221;--card:#171a2b;--soft:#20243a;--text:#e8ecf3;--muted:#a7b0c0;--brand:#7c5cff;--brand-2:#2ee6a6;--danger:#ff6b6b;--warn:#ffb020;--ok:#2ee6a6;
      --radius:16px;--shadow:0 10px 30px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu; background:linear-gradient(120deg,#0d0f1b,#131733 60%,#0e1330); color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:rgba(13,15,27,.75);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.06)}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .title{display:flex;gap:12px;align-items:center}
    .title h1{margin:10px 0;font-size:20px;font-weight:700}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(124,92,255,.15);color:#d8d0ff;border:1px solid rgba(124,92,255,.3)}

    .tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
    .tab{cursor:pointer;padding:12px;border-radius:12px;text-align:center;background:var(--soft);color:var(--muted);border:1px solid transparent}
    .tab.active{background:linear-gradient(180deg,rgba(124,92,255,.18),rgba(124,92,255,.08));color:var(--text);border-color:rgba(124,92,255,.35)}

    .grid{display:grid;gap:16px}
    .inventory{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card.pad{padding:14px}
    .row{display:flex;align-items:center;gap:12px}
    .row.wrap{flex-wrap:wrap}

    .input{display:flex;flex-direction:column;gap:6px;width:100%}
    .input input,.input select,.input textarea{
      background:#0e1226;border:1px solid rgba(255,255,255,.06);color:var(--text);padding:12px;border-radius:12px;outline:none
    }
    .input input::placeholder{color:#92a0b6}
    label{font-size:12px;color:var(--muted)}

    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button{cursor:pointer;border:none}
    .btn{padding:10px 14px;border-radius:12px;background:var(--soft);color:var(--text);border:1px solid rgba(255,255,255,.08)}
    .btn.brand{background:linear-gradient(135deg,var(--brand),#9b86ff);box-shadow:0 6px 18px rgba(124,92,255,.4)}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.12)}
    .btn.danger{background:linear-gradient(135deg,#ff6b6b,#ff9776)}
    .btn.warn{background:linear-gradient(135deg,#ffb020,#ffd26f);color:#2d2300}
    .btn.ok{background:linear-gradient(135deg,#2ee6a6,#79f0c9);color:#00271c}

    .thumb{width:64px;height:64px;border-radius:12px;background:#0e1226;border:1px solid rgba(255,255,255,.08);object-fit:cover}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:#0e1226;color:var(--muted)}

    .footer{opacity:.7;font-size:12px;text-align:center;margin:20px 0}

    .hide{display:none}
    .right{margin-left:auto}

    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);margin:10px 0}

    .empty{opacity:.7;text-align:center;padding:30px}

    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpi .card{padding:12px}
    .kpi h3{margin:0;font-size:13px;color:var(--muted)}
    .kpi .val{font-size:20px;margin-top:4px}

    @media (max-width:640px){
      .kpi{grid-template-columns:1fr}
      .tabs{grid-template-columns:1fr 1fr 1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="title">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 8h16M4 12h16M4 16h16" stroke="#7c5cff" stroke-width="2" stroke-linecap="round"/></svg>
        <h1>Brick Manager</h1>
        <span class="badge">Offline • LocalStorage</span>
        <span class="pill right" id="lastSaved">—</span>
      </div>
      <div class="tabs">
        <div class="tab active" data-tab="inventory">Inventory</div>
        <div class="tab" data-tab="sell">Calculator / Sell</div>
        <div class="tab" data-tab="history">Sales History</div>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:12px">
    <!-- KPIs -->
    <section class="kpi" id="kpis">
      <div class="card"><h3>Total items</h3><div class="val" id="kpiItems">0</div></div>
      <div class="card"><h3>Inventory value</h3><div class="val" id="kpiValue">0</div></div>
      <div class="card"><h3>Total mass (kg)</h3><div class="val" id="kpiMass">0</div></div>
    </section>

    <!-- INVENTORY TAB -->
    <section id="inventoryTab">
      <div class="card pad" style="margin-top:16px">
        <div class="row wrap">
          <div class="input" style="max-width:120px">
            <label>Photo</label>
            <img id="preview" class="thumb" alt="preview" />
            <input type="file" id="img" accept="image/*" />
          </div>
          <div class="input"><label>Name</label><input id="name" placeholder="e.g., M150 solid"/></div>
          <div class="input" style="max-width:120px"><label>Price / pc</label><input id="price" type="number" min="0" step="0.01" placeholder="0.00"/></div>
          <div class="input" style="max-width:120px"><label>Mass / pc (kg)</label><input id="mass" type="number" min="0" step="0.01" placeholder="kg"/></div>
          <div class="input" style="max-width:120px"><label>Size X (mm)</label><input id="sx" type="number" min="0" step="1" placeholder="250"/></div>
          <div class="input" style="max-width:120px"><label>Size Y (mm)</label><input id="sy" type="number" min="0" step="1" placeholder="120"/></div>
          <div class="input" style="max-width:120px"><label>Size Z (mm)</label><input id="sz" type="number" min="0" step="1" placeholder="65"/></div>
          <div class="input" style="max-width:140px"><label>Quantity (pcs)</label><input id="qty" type="number" min="0" step="1" placeholder="0"/></div>
        </div>
        <div class="row actions" style="margin-top:10px">
          <button class="btn brand" id="saveBtn">Add brick</button>
          <button class="btn ghost" id="resetBtn">Reset</button>
          <span class="pill">Sizes in mm • Area uses X×Y</span>
        </div>
      </div>

      <div id="inventoryList" class="grid inventory" style="margin-top:16px"></div>
      <div class="empty" id="emptyInv">No bricks yet. Add your first brick above.</div>
    </section>

    <!-- SELL TAB -->
    <section id="sellTab" class="hide">
      <div class="card pad" style="margin-top:16px">
        <div class="row wrap">
          <div class="input"><label>Brick type</label><select id="sellBrick"></select></div>
          <div class="input" style="max-width:160px"><label>Quantity to sell</label><input id="sellQty" type="number" min="1" step="1" placeholder="1"/></div>
        </div>
        <div class="divider"></div>
        <div class="row wrap">
          <span class="pill" id="calcPrice">Total cost: —</span>
          <span class="pill" id="calcMass">Total mass: —</span>
          <span class="pill" id="calcArea">Area (X×Y): —</span>
          <span class="pill" id="stockLeft">Stock after sale: —</span>
        </div>
        <div class="actions" style="margin-top:12px">
          <button class="btn ok" id="completeSale">Complete sale</button>
          <button class="btn ghost" id="sellReset">Reset</button>
        </div>
      </div>
    </section>

    <!-- HISTORY TAB -->
    <section id="historyTab" class="hide">
      <div class="row actions" style="margin-top:16px;margin-bottom:10px">
        <button class="btn ghost" id="exportCSV">Export CSV</button>
        <button class="btn warn" id="clearHistory">Clear history</button>
      </div>
      <div id="historyList" class="grid" style="grid-template-columns:1fr"></div>
      <div class="empty" id="emptyHistory">No sales yet.</div>
    </section>

    <div class="footer">Made for you — works fully offline in any modern mobile browser. Data is saved on this device only.</div>
  </main>

  <template id="tpl-card">
    <div class="card pad">
      <div class="row">
        <img class="thumb"/>
        <div style="flex:1">
          <div class="row" style="gap:8px;align-items:baseline">
            <strong class="name" style="font-size:16px"></strong>
            <span class="pill sku"></span>
          </div>
          <div class="row wrap" style="margin-top:6px;gap:8px">
            <span class="pill price"></span>
            <span class="pill mass"></span>
            <span class="pill size"></span>
            <span class="pill qty"></span>
          </div>
        </div>
      </div>
      <div class="actions" style="margin-top:12px">
        <button class="btn" data-act="edit">Edit</button>
        <button class="btn danger" data-act="del">Delete</button>
      </div>
    </div>
  </template>

  <template id="tpl-history">
    <div class="card pad">
      <div class="row wrap" style="gap:10px">
        <span class="pill time"></span>
        <span class="pill name"></span>
        <span class="pill qty"></span>
        <span class="pill price"></span>
        <span class="pill mass"></span>
        <span class="pill area"></span>
        <span class="pill left"></span>
      </div>
    </div>
  </template>

  <script>
    // ---- Utilities ----
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmt = new Intl.NumberFormat(undefined,{maximumFractionDigits:2});
    const nowStr = () => new Date().toLocaleString();

    // ---- Storage ----
    const STORE_KEY = 'brick_manager_store_v1';
    const store = {
      bricks: [], // {id, name, price, mass, sx, sy, sz, qty, img}
      sales: []   // {time, brickId, name, qty, totalPrice, totalMass, totalAreaM2, stockLeft}
    };

    function load(){
      const raw = localStorage.getItem(STORE_KEY);
      if(raw){
        try{const s = JSON.parse(raw); Object.assign(store,s);}catch(e){console.warn('reset store',e)}
      }
      touchSaved();
    }
    function save(){
      localStorage.setItem(STORE_KEY, JSON.stringify(store));
      touchSaved();
    }
    function touchSaved(){
      $('#lastSaved').textContent = 'Saved: ' + nowStr();
    }

    // ---- Image handling ----
    const imgInput = $('#img');
    const preview = $('#preview');
    imgInput.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = () => { preview.src = reader.result; };
      reader.readAsDataURL(f);
    });

    // ---- Inventory form (create / update) ----
    let editingId = null;
    function resetForm(){
      editingId = null;
      preview.src = '';
      $('#name').value = '';
      $('#price').value = '';
      $('#mass').value = '';
      $('#sx').value = '';
      $('#sy').value = '';
      $('#sz').value = '';
      $('#qty').value = '';
      $('#saveBtn').textContent = 'Add brick';
    }

    $('#resetBtn').addEventListener('click', resetForm);

    $('#saveBtn').addEventListener('click', ()=>{
      const name = $('#name').value.trim();
      const price = parseFloat($('#price').value)||0;
      const mass = parseFloat($('#mass').value)||0;
      const sx = parseFloat($('#sx').value)||0;
      const sy = parseFloat($('#sy').value)||0;
      const sz = parseFloat($('#sz').value)||0;
      const qty = Math.max(0, parseInt($('#qty').value)||0);
      const img = preview.src||'';
      if(!name){ alert('Name is required'); return; }

      if(editingId){
        const i = store.bricks.findIndex(b=>b.id===editingId);
        if(i>-1){ store.bricks[i] = {...store.bricks[i], name, price, mass, sx, sy, sz, qty, img}; }
      }else{
        const id = crypto.randomUUID();
        store.bricks.push({id, name, price, mass, sx, sy, sz, qty, img});
      }
      save();
      renderAll();
      resetForm();
    });

    // ---- Render inventory ----
    function renderInventory(){
      const list = $('#inventoryList');
      list.innerHTML = '';
      $('#emptyInv').classList.toggle('hide', store.bricks.length>0);
      for(const b of store.bricks){
        const tpl = document.getElementById('tpl-card');
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('img').src = b.img || '';
        node.querySelector('.name').textContent = b.name;
        node.querySelector('.sku').textContent = `${b.sx}×${b.sy}×${b.sz} mm`;
        node.querySelector('.price').textContent = `Price: ${fmt.format(b.price)}`;
        node.querySelector('.mass').textContent = `Mass: ${fmt.format(b.mass)} kg`;
        node.querySelector('.size').textContent = `Area X×Y: ${fmt.format(areaXY(b))} m² / pc`;
        node.querySelector('.qty').textContent = `Qty: ${fmt.format(b.qty)} pcs`;
        node.querySelector('[data-act="edit"]').addEventListener('click', ()=> startEdit(b.id));
        node.querySelector('[data-act="del"]').addEventListener('click', ()=> delBrick(b.id));
        list.appendChild(node);
      }
      // Populate selector in Sell tab
      const sel = $('#sellBrick');
      sel.innerHTML = '';
      for(const b of store.bricks){
        const opt = document.createElement('option');
        opt.value = b.id; opt.textContent = `${b.name} (${b.sx}×${b.sy}×${b.sz} mm)`;
        sel.appendChild(opt);
      }
      if(store.bricks.length===0){
        const opt = document.createElement('option');
        opt.textContent = '— add bricks first —';
        sel.appendChild(opt);
      }
    }

    function startEdit(id){
      const b = store.bricks.find(b=>b.id===id); if(!b) return;
      editingId = id;
      preview.src = b.img||'';
      $('#name').value = b.name;
      $('#price').value = b.price;
      $('#mass').value = b.mass;
      $('#sx').value = b.sx; $('#sy').value = b.sy; $('#sz').value = b.sz;
      $('#qty').value = b.qty;
      $('#saveBtn').textContent = 'Save changes';
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function delBrick(id){
      if(!confirm('Delete this brick type?')) return;
      const i = store.bricks.findIndex(b=>b.id===id);
      if(i>-1){ store.bricks.splice(i,1); save(); renderAll(); }
    }

    function areaXY(b){ return (b.sx/1000) * (b.sy/1000); }

    // ---- KPIs ----
    function renderKPI(){
      const totalItems = store.bricks.reduce((s,b)=>s+b.qty,0);
      const value = store.bricks.reduce((s,b)=>s+b.price*b.qty,0);
      const mass = store.bricks.reduce((s,b)=>s+b.mass*b.qty,0);
      $('#kpiItems').textContent = fmt.format(totalItems);
      $('#kpiValue').textContent = fmt.format(value);
      $('#kpiMass').textContent = fmt.format(mass);
    }

    // ---- Sell / calculator ----
    function currentBrick(){
      const id = $('#sellBrick').value; return store.bricks.find(b=>b.id===id);
    }
    function updateCalc(){
      const b = currentBrick();
      const q = Math.max(0, parseInt($('#sellQty').value)||0);
      if(!b || !q){
        $('#calcPrice').textContent = 'Total cost: —';
        $('#calcMass').textContent = 'Total mass: —';
        $('#calcArea').textContent = 'Area (X×Y): —';
        $('#stockLeft').textContent = 'Stock after sale: —';
        return;
      }
      const price = b.price*q;
      const mass = b.mass*q;
      const area = areaXY(b)*q;
      const left = b.qty - q;
      $('#calcPrice').textContent = `Total cost: ${fmt.format(price)}`;
      $('#calcMass').textContent = `Total mass: ${fmt.format(mass)} kg`;
      $('#calcArea').textContent = `Area (X×Y): ${fmt.format(area)} m²`;
      $('#stockLeft').textContent = `Stock after sale: ${fmt.format(left)} pcs`;
    }

    $('#sellBrick').addEventListener('change', updateCalc);
    $('#sellQty').addEventListener('input', updateCalc);
    $('#sellReset').addEventListener('click', ()=>{ $('#sellQty').value=''; updateCalc(); });

    $('#completeSale').addEventListener('click', ()=>{
      const b = currentBrick(); if(!b){ alert('No brick selected'); return; }
      const q = Math.max(1, parseInt($('#sellQty').value)||0);
      if(q> b.qty){ alert('Not enough stock'); return; }
      const totalPrice = b.price*q;
      const totalMass = b.mass*q;
      const totalAreaM2 = areaXY(b)*q;
      b.qty -= q;
      const rec = { time: nowStr(), brickId: b.id, name: b.name, qty:q, totalPrice, totalMass, totalAreaM2, stockLeft:b.qty };
      store.sales.unshift(rec);
      save();
      renderAll();
      // Reset sell form
      $('#sellQty').value=''; updateCalc();
      alert('Sale completed');
    });

    // ---- History ----
    function renderHistory(){
      const box = $('#historyList');
      box.innerHTML = '';
      $('#emptyHistory').classList.toggle('hide', store.sales.length>0);
      for(const s of store.sales){
        const tpl = document.getElementById('tpl-history');
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.time').textContent = s.time;
        node.querySelector('.name').textContent = s.name;
        node.querySelector('.qty').textContent = `Qty: ${fmt.format(s.qty)}`;
        node.querySelector('.price').textContent = `Cost: ${fmt.format(s.totalPrice)}`;
        node.querySelector('.mass').textContent = `Mass: ${fmt.format(s.totalMass)} kg`;
        node.querySelector('.area').textContent = `Area: ${fmt.format(s.totalAreaM2)} m²`;
        node.querySelector('.left').textContent = `Left: ${fmt.format(s.stockLeft)} pcs`;
        box.appendChild(node);
      }
    }

    $('#clearHistory').addEventListener('click', ()=>{
      if(!confirm('Clear all sales history?')) return;
      store.sales = []; save(); renderHistory();
    });

    $('#exportCSV').addEventListener('click', ()=>{
      if(store.sales.length===0){ alert('No sales to export'); return; }
      const rows = [['time','name','qty','total_price','total_mass_kg','total_area_m2','stock_left']]
        .concat(store.sales.map(s=>[s.time,s.name,s.qty,s.totalPrice,s.totalMass,s.totalAreaM2,s.stockLeft]));
      const csv = rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'sales_history.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // ---- Tabs ----
    $$('.tab').forEach(t=>t.addEventListener('click',()=>{
      $$('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const tab = t.dataset.tab;
      $('#inventoryTab').classList.toggle('hide', tab!=='inventory');
      $('#sellTab').classList.toggle('hide', tab!=='sell');
      $('#historyTab').classList.toggle('hide', tab!=='history');
      window.scrollTo({top:0,behavior:'smooth'});
    }));

    // ---- Boot ----
    function renderAll(){
      renderInventory();
      renderKPI();
      renderHistory();
    }

    load();
    renderAll();
  </script>
</body>
</html>
